<script>
(() => {
  'use strict';

  const CORE_VERSION = '1.0.0';
  const STORAGE_KEY = 'grocy_nerdcore_settings_v1';
  const ADDONS = new Map();

  const MESSAGES = {
    fr: {
      menu_label: 'Parametres NerdCore',
      page_title: 'Parametres NerdCore',
      page_subtitle: 'NerdCore centralise les reglages communs et gere la dependance des addons.',
      core_group_title: 'Reglages communs',
      lang_label: 'Langue interface NerdCore',
      lang_auto: 'Auto (navigateur)',
      lang_fr: 'Francais',
      lang_en: 'Anglais',
      legacy_label: 'Masquer les anciens boutons/overlays parametres des addons',
      save_btn: 'Sauvegarder',
      saved_ok: 'Parametres NerdCore sauvegardes.',
      addon_group_title: 'Addons detectes',
      addon_group_hint: 'StatNerd et ProductHelper doivent etre installes avec NerdCore.',
      addon_none: 'Aucun addon enregistre pour le moment.',
      addon_required: 'NerdCore requis',
      addon_name: 'Nom',
      addon_version: 'Version',
      addon_status: 'Statut',
      addon_status_loaded: 'Charge',
      addon_status_waiting: 'En attente',
      open_settings_link: 'Ouvrir les parametres NerdCore',
    },
    en: {
      menu_label: 'NerdCore settings',
      page_title: 'NerdCore settings',
      page_subtitle: 'NerdCore centralizes shared settings and enforces addon dependency.',
      core_group_title: 'Shared settings',
      lang_label: 'NerdCore UI language',
      lang_auto: 'Auto (browser)',
      lang_fr: 'French',
      lang_en: 'English',
      legacy_label: 'Hide legacy addon settings buttons/overlays',
      save_btn: 'Save',
      saved_ok: 'NerdCore settings saved.',
      addon_group_title: 'Detected addons',
      addon_group_hint: 'StatNerd and ProductHelper require NerdCore.',
      addon_none: 'No addon registered yet.',
      addon_required: 'NerdCore required',
      addon_name: 'Name',
      addon_version: 'Version',
      addon_status: 'Status',
      addon_status_loaded: 'Loaded',
      addon_status_waiting: 'Waiting',
      open_settings_link: 'Open NerdCore settings',
    },
  };

  function clean(value) {
    return String(value == null ? '' : value).trim();
  }

  function normalizeLang(value) {
    const v = clean(value).toLowerCase();
    if (v.startsWith('fr')) return 'fr';
    return 'en';
  }

  function baseUrl() {
    if (window.Grocy && typeof window.Grocy.BaseUrl === 'string' && window.Grocy.BaseUrl) {
      return window.Grocy.BaseUrl.replace(/\/+$/, '');
    }
    return `${window.location.protocol}//${window.location.host}`;
  }

  function detectBrowserLang() {
    const htmlLang = clean(document.documentElement && document.documentElement.lang ? document.documentElement.lang : '');
    if (htmlLang) return normalizeLang(htmlLang);
    const navLang = clean(window.navigator && (window.navigator.language || window.navigator.userLanguage) ? (window.navigator.language || window.navigator.userLanguage) : '');
    if (navLang) return normalizeLang(navLang);
    return 'en';
  }

  function defaultSettings() {
    return {
      uiLanguageMode: 'auto',
      hideLegacyAddonSettings: true,
    };
  }

  function loadSettings() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return defaultSettings();
      const parsed = JSON.parse(raw);
      const merged = Object.assign(defaultSettings(), parsed || {});
      if (!['auto', 'fr', 'en'].includes(clean(merged.uiLanguageMode).toLowerCase())) {
        merged.uiLanguageMode = 'auto';
      }
      merged.hideLegacyAddonSettings = merged.hideLegacyAddonSettings !== false;
      return merged;
    } catch (_err) {
      return defaultSettings();
    }
  }

  let SETTINGS = loadSettings();

  function saveSettings(next) {
    SETTINGS = Object.assign(defaultSettings(), next || {});
    SETTINGS.hideLegacyAddonSettings = SETTINGS.hideLegacyAddonSettings !== false;
    if (!['auto', 'fr', 'en'].includes(clean(SETTINGS.uiLanguageMode).toLowerCase())) {
      SETTINGS.uiLanguageMode = 'auto';
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(SETTINGS));
    applyLegacyVisibility();
    window.dispatchEvent(new CustomEvent('nerdcore:settings-updated', { detail: SETTINGS }));
  }

  function currentLang() {
    if (SETTINGS.uiLanguageMode && SETTINGS.uiLanguageMode !== 'auto') {
      return SETTINGS.uiLanguageMode;
    }
    return detectBrowserLang();
  }

  function t(key) {
    const lang = currentLang();
    const dict = MESSAGES[lang] || MESSAGES.en;
    return dict[key] || MESSAGES.en[key] || key;
  }

  function notify(message) {
    if (window.toastr && typeof window.toastr.success === 'function') {
      window.toastr.success(message);
      return;
    }
    console.info(message);
  }

  function applyLegacyVisibility() {
    const styleId = 'nerdcore-legacy-hide-style';
    const existing = document.getElementById(styleId);
    if (!SETTINGS.hideLegacyAddonSettings) {
      if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
      return;
    }
    if (existing) return;
    const style = document.createElement('style');
    style.id = styleId;
    style.textContent = `
      #dash_ai_settings_open,
      #dash_focus_ai_settings,
      #dash_ai_settings_overlay {
        display: none !important;
      }
    `;
    document.head.appendChild(style);
  }

  function openSettingsPage() {
    const url = `${baseUrl()}/stocksettings?nerdcore=1`;
    window.location.href = url;
  }

  function getSettingsMenuAnchor() {
    const anchors = Array.from(document.querySelectorAll('a.dropdown-item.discrete-link[href]'));
    return anchors.find((a) => /\/stocksettings(?:\?|$)/.test(a.getAttribute('href') || '')) || null;
  }

  function ensureSettingsMenuEntry() {
    const stockAnchor = getSettingsMenuAnchor();
    if (!stockAnchor || !stockAnchor.parentNode) return;
    if (document.getElementById('nerdcore-settings-link')) return;

    const link = document.createElement('a');
    link.id = 'nerdcore-settings-link';
    link.className = stockAnchor.className || 'dropdown-item discrete-link';
    link.href = `${baseUrl()}/stocksettings?nerdcore=1`;
    link.innerHTML = '<i class="fa-solid fa-fw fa-brain"></i>&nbsp;' + t('menu_label');
    link.title = t('open_settings_link');

    if (stockAnchor.nextSibling) {
      stockAnchor.parentNode.insertBefore(link, stockAnchor.nextSibling);
    } else {
      stockAnchor.parentNode.appendChild(link);
    }
  }

  function isNerdCoreSettingsPage() {
    const view = clean(window.Grocy && window.Grocy.View ? window.Grocy.View : '').toLowerCase();
    if (view !== 'stocksettings') return false;
    const params = new URLSearchParams(window.location.search || '');
    return params.get('nerdcore') === '1';
  }

  function addonRowsHtml() {
    if (!ADDONS.size) {
      return `<div class="small text-muted">${t('addon_none')}</div>`;
    }

    const rows = Array.from(ADDONS.values()).map((addon) => {
      const name = clean(addon.name || addon.id || 'addon');
      const version = clean(addon.version || '-');
      return `
        <tr>
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(version)}</td>
          <td><span class="badge badge-success">${escapeHtml(t('addon_status_loaded'))}</span></td>
        </tr>
      `;
    }).join('');

    return `
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0">
          <thead>
            <tr>
              <th>${escapeHtml(t('addon_name'))}</th>
              <th>${escapeHtml(t('addon_version'))}</th>
              <th>${escapeHtml(t('addon_status'))}</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function escapeHtml(value) {
    return String(value == null ? '' : value)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function renderSettingsPage() {
    if (!isNerdCoreSettingsPage()) return;
    const pageContent = document.getElementById('page-content');
    if (!pageContent) return;

    pageContent.innerHTML = `
      <div class="row">
        <div class="col">
          <h2 class="title">${escapeHtml(t('page_title'))}</h2>
          <div class="small text-muted mb-2">${escapeHtml(t('page_subtitle'))}</div>
        </div>
      </div>
      <hr class="my-2">
      <div class="row">
        <div class="col-12 col-lg-6 mb-3">
          <div class="card">
            <div class="card-header font-weight-bold">${escapeHtml(t('core_group_title'))}</div>
            <div class="card-body">
              <div class="form-group">
                <label for="nerdcore_ui_lang_mode">${escapeHtml(t('lang_label'))}</label>
                <select id="nerdcore_ui_lang_mode" class="custom-control custom-select">
                  <option value="auto">${escapeHtml(t('lang_auto'))}</option>
                  <option value="fr">${escapeHtml(t('lang_fr'))}</option>
                  <option value="en">${escapeHtml(t('lang_en'))}</option>
                </select>
              </div>
              <div class="custom-control custom-switch mb-3">
                <input type="checkbox" class="custom-control-input" id="nerdcore_hide_legacy">
                <label class="custom-control-label" for="nerdcore_hide_legacy">${escapeHtml(t('legacy_label'))}</label>
              </div>
              <button id="nerdcore_save_btn" type="button" class="btn btn-primary btn-sm">${escapeHtml(t('save_btn'))}</button>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6 mb-3">
          <div class="card">
            <div class="card-header font-weight-bold">${escapeHtml(t('addon_group_title'))}</div>
            <div class="card-body">
              <div class="small text-muted mb-2">${escapeHtml(t('addon_group_hint'))} <span class="badge badge-secondary">${escapeHtml(t('addon_required'))}</span></div>
              <div id="nerdcore_addons_table">${addonRowsHtml()}</div>
            </div>
          </div>
        </div>
      </div>
    `;

    const langSelect = document.getElementById('nerdcore_ui_lang_mode');
    const legacySwitch = document.getElementById('nerdcore_hide_legacy');
    const saveBtn = document.getElementById('nerdcore_save_btn');

    if (langSelect) langSelect.value = SETTINGS.uiLanguageMode || 'auto';
    if (legacySwitch) legacySwitch.checked = SETTINGS.hideLegacyAddonSettings !== false;

    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        const next = Object.assign({}, SETTINGS, {
          uiLanguageMode: langSelect ? clean(langSelect.value || 'auto').toLowerCase() : 'auto',
          hideLegacyAddonSettings: legacySwitch ? !!legacySwitch.checked : true,
        });
        saveSettings(next);
        renderSettingsPage();
        notify(t('saved_ok'));
      });
    }
  }

  function registerAddon(meta) {
    const id = clean(meta && meta.id ? meta.id : '');
    if (!id) return;
    ADDONS.set(id, {
      id,
      name: clean(meta && meta.name ? meta.name : id),
      version: clean(meta && meta.version ? meta.version : ''),
    });
    const table = document.getElementById('nerdcore_addons_table');
    if (table) table.innerHTML = addonRowsHtml();
    window.dispatchEvent(new CustomEvent('nerdcore:addon-registered', { detail: { id } }));
  }

  function boot() {
    applyLegacyVisibility();
    ensureSettingsMenuEntry();
    renderSettingsPage();
  }

  window.NerdCore = {
    version: CORE_VERSION,
    registerAddon,
    openSettingsPage,
    getSettings: () => Object.assign({}, SETTINGS),
    saveSettings: (next) => saveSettings(next),
    getUiLanguage: () => currentLang(),
    isLegacySettingsDisabled: () => SETTINGS.hideLegacyAddonSettings !== false,
    t,
  };

  window.dispatchEvent(new CustomEvent('nerdcore:ready', { detail: { version: CORE_VERSION } }));

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot, { once: true });
  } else {
    boot();
  }

  setTimeout(ensureSettingsMenuEntry, 800);
  setTimeout(ensureSettingsMenuEntry, 2500);
})();
</script>
